stages:
  - build
  - deploy

variables:
  DOCKER_USER: "$DOCKER_USER"
  DOCKER_PASSWORD: "$DOCKER_PASSWORD"
  SSH_HOST: "$SSH_HOST"

# -------------------------------
# Build Backend
# -------------------------------
backend-build:
  stage: build
  image: docker:20
  services:
    - docker:dind
  script:
    # Loguear en Docker Hub
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
    # Construir y subir la imagen
    - cd backend
    - docker build -t $DOCKER_USER/backend:1.0 .
    - docker push $DOCKER_USER/backend:1.0
  only:
    - main

# -------------------------------
# Build Frontend
# -------------------------------
frontend-build:
  stage: build
  image: docker:20
  services:
    - docker:dind
  script:
    # Loguear en Docker Hub
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
    # Construir y subir la imagen
    - cd frontend
    - docker build -t $DOCKER_USER/frontend:1.0 .
    - docker push $DOCKER_USER/frontend:1.0
  only:
    - main

# -------------------------------
# Deploy al servidor via SSH
# -------------------------------
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    # Instalar cliente SSH
    - apk add --no-cache openssh-client
    # Configurar llave SSH
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # Confiar en el host
    - ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
  script:
    # Conectarse al servidor y ejecutar el deploy
    - ssh ubuntu@$SSH_HOST "cd /var/www/red-vibes && ./deploy.sh"
  only:
    - main
